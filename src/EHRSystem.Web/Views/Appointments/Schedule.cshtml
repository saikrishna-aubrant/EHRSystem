@model AppointmentScheduleViewModel
@{
    ViewData["Title"] = "Schedule Appointment";
}

<!-- [REQ: US-APT-01.20] Appointment scheduling form -->
<div class="card">
    <div class="card-header">
        <h3 class="mb-0">Schedule Appointment</h3>
    </div>
    <div class="card-body">
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
        <form asp-action="Schedule" method="post" id="appointmentForm">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="PatientId" />
            <input type="hidden" asp-for="PatientName" />

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="DoctorId" class="form-label"></label>
                    <select asp-for="DoctorId" asp-items="Model.DoctorList" class="form-select" required>
                        <option value="">Select Doctor</option>
                    </select>
                    <span asp-validation-for="DoctorId" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="AppointmentDate" class="form-label"></label>
                    <input asp-for="AppointmentDate" class="form-control" type="date" min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" required />
                    <span asp-validation-for="AppointmentDate" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="TimeSlotId" class="form-label"></label>
                    <select asp-for="TimeSlotId" class="form-select" required>
                        <option value="">Select Time Slot</option>
                    </select>
                    <span asp-validation-for="TimeSlotId" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="ReasonForVisit" class="form-label"></label>
                    <textarea asp-for="ReasonForVisit" class="form-control" rows="3" required></textarea>
                    <span asp-validation-for="ReasonForVisit" class="text-danger"></span>
                </div>
            </div>

            <div class="alert alert-info">
                <h5>Appointment Guidelines:</h5>
                <ul class="mb-0">
                    <li>Appointments must be scheduled at least 1 day in advance</li>
                    <li>Available hours: 9:00 AM - 5:00 PM</li>
                    <li>Duration: 30 minutes</li>
                    <li>15-minute buffer between appointments</li>
                </ul>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary" id="submitButton">Schedule Appointment</button>
                <a asp-action="Index" class="btn btn-secondary">Back to Appointments</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // [REQ: US-APT-01.21] Dynamic time slot loading
        $(document).ready(function() {
            function loadTimeSlots() {
                var doctorId = $("#DoctorId").val();
                var date = $("#AppointmentDate").val();
                var timeSlotSelect = $("#TimeSlotId");
                
                timeSlotSelect.empty();
                timeSlotSelect.append($('<option>', {
                    value: '',
                    text: 'Select Time Slot'
                }));
                
                if (doctorId && date) {
                    $.get('@Url.Action("GetTimeSlots")', { doctorId: doctorId, date: date })
                        .done(function(data) {
                            if (data && data.length > 0) {
                                $.each(data, function(i, item) {
                                    timeSlotSelect.append($('<option>', {
                                        value: item.value,
                                        text: item.text
                                    }));
                                });
                            } else {
                                timeSlotSelect.append($('<option>', {
                                    value: '',
                                    text: 'No available slots for this date'
                                }));
                            }
                        })
                        .fail(function() {
                            $("#errorMessage").text("Failed to load time slots. Please try again.").show();
                        });
                }
            }

            $("#DoctorId, #AppointmentDate").change(loadTimeSlots);
            
            if ($("#DoctorId").val()) {
                loadTimeSlots();
            }

            $("#appointmentForm").on("submit", function(e) {
                e.preventDefault();
                var submitButton = $("#submitButton");
                submitButton.prop('disabled', true);
                $("#errorMessage").hide();

                $.ajax({
                    url: $(this).attr('action'),
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.redirectUrl) {
                            window.location.href = response.redirectUrl;
                        } else {
                            window.location.href = '@Url.Action("Calendar", "Appointments")';
                        }
                    },
                    error: function(xhr) {
                        submitButton.prop('disabled', false);
                        var errorMessage = "Failed to request appointment. Please try again.";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        $("#errorMessage").text(errorMessage).show();
                    }
                });
            });
        });
    </script>
} 